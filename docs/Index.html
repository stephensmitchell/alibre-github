<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Alibre Design on GitHub</title>
  <link rel="stylesheet" href="./theme.css">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font: 14px/1.55 "Segoe UI", "Inter", system-ui, sans-serif;
      color: var(--color-neutral-12, #0f172a);
      background: var(--color-bg, var(--color-neutral-1, #f5f7fb));
    }
    .topbar {
      position: sticky;
      top: 0;
      z-index: 20;
      border-bottom: 1px solid var(--color-neutral-6, #d5dbe6);
      backdrop-filter: blur(8px);
      background: color-mix(in srgb, var(--color-neutral-1, #f5f7fb) 86%, transparent);
    }
    .topbar-inner {
      width: 100%;
      margin: 0;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .title { font-weight: 700; }
    .meta { color: var(--color-neutral-11, #475569); }
    .spacer { flex: 1; }
    button, select {
      border: 1px solid var(--color-neutral-6, #d5dbe6);
      background: var(--color-neutral-2, #fff);
      color: var(--color-neutral-12, #0f172a);
      border-radius: 10px;
      padding: 8px 12px;
      font-weight: 600;
    }
    button { cursor: pointer; }
    select { min-width: 180px; }
    main { width: 100%; margin: 0; padding: 0; }
    .layout {
      display: grid;
      grid-template-columns: 290px minmax(0, 1fr);
      gap: 16px;
      width: 100%;
    }
    .toc {
      position: sticky;
      top: 64px;
      align-self: start;
      max-height: calc(100vh - 84px);
      overflow: auto;
      border: 0;
      border-right: 1px solid var(--color-neutral-6, #d5dbe6);
      border-radius: 0;
      background: transparent;
      padding: 10px 12px 10px 10px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .toc::-webkit-scrollbar { display: none; }
    .toc-title {
      font-weight: 700;
      margin: 2px 4px 8px;
      color: var(--color-neutral-11, #475569);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .06em;
    }
    .toc a {
      display: block;
      padding: 5px 8px;
      border-radius: 8px;
      color: var(--color-neutral-12, #0f172a);
      text-decoration: none;
      font-size: 13px;
      line-height: 1.35;
    }
    .toc a:hover {
      background: var(--color-neutral-3, #eef2f7);
      text-decoration: none;
    }
    .toc a.l2 { padding-left: 16px; color: var(--color-neutral-11, #475569); }
    .toc a.l3 { padding-left: 24px; color: var(--color-neutral-11, #475569); }
    .report {
      background: var(--color-bg, var(--color-neutral-1, #f5f7fb));
      border: 0;
      border-radius: 0;
      padding: 12px 20px 24px;
      width: 100%;
    }
    h1,h2,h3,h4 { line-height: 1.25; scroll-margin-top: 84px; }
    h2 { margin-top: 22px; padding-top: 14px; border-top: 1px solid var(--color-neutral-6, #d5dbe6); }
    h3 { color: var(--color-accent-11, #0f766e); }
    a { color: var(--color-accent-11, #0f766e); text-decoration: none; }
    .report a {
      text-decoration: underline;
      text-underline-offset: 2px;
      text-decoration-thickness: 1px;
    }
    .report a:hover {
      text-decoration-thickness: 2px;
    }
    pre, code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    pre {
      background: var(--color-neutral-1, #f8fafc);
      border: 1px solid var(--color-neutral-6, #d5dbe6);
      border-radius: 10px;
      padding: 12px;
      overflow: auto;
    }
    code {
      background: var(--color-neutral-1, #f8fafc);
      border: 1px solid var(--color-neutral-6, #d5dbe6);
      border-radius: 6px;
      padding: 1px 6px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      min-width: 760px;
    }
    .table-wrap {
      border: 1px solid var(--color-neutral-6, #d5dbe6);
      border-radius: 12px;
      overflow: auto;
      margin: 10px 0 14px;
      width: 100%;
    }
    th, td {
      border-right: 1px solid var(--color-neutral-6, #d5dbe6);
      border-bottom: 1px solid var(--color-neutral-6, #d5dbe6);
      padding: 6px 8px;
      text-align: left;
      vertical-align: top;
      white-space: nowrap;
    }
    th:last-child, td:last-child { border-right: 0; }
    thead th {
      background: var(--color-neutral-3, #eef2f7);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .mermaid-wrap {
      border: 1px solid var(--color-neutral-6, #d5dbe6);
      border-radius: 12px;
      padding: 10px;
      margin: 10px 0 16px;
      overflow: auto;
    }
    .mermaid-wrap .mermaid svg {
      max-width: none;
    }
    .mermaid svg text,
    .mermaid svg tspan,
    .mermaid .legend text,
    .mermaid .label {
      fill: var(--color-neutral-12, #0f172a) !important;
      color: var(--color-neutral-12, #0f172a) !important;
    }
    .mermaid svg .pieTitleText { fill: var(--color-neutral-11, #475569) !important; }
    .mermaid foreignObject,
    .mermaid foreignObject *,
    .mermaid .nodeLabel,
    .mermaid .edgeLabel,
    .mermaid .cluster-label,
    .mermaid .label {
      color: var(--color-neutral-12, #0f172a) !important;
      fill: var(--color-neutral-12, #0f172a) !important;
    }
    /* xychart-beta often emits low-opacity labels; force readable foreground */
    .mermaid svg text,
    .mermaid svg tspan {
      fill: var(--color-neutral-12, #0f172a) !important;
      opacity: 1 !important;
    }
    .mermaid svg [class*="axis"] text,
    .mermaid svg [class*="tick"] text,
    .mermaid svg [class*="title"] text,
    .mermaid svg [class*="label"] text {
      fill: var(--color-neutral-12, #0f172a) !important;
      opacity: 1 !important;
    }
    .mermaid svg .x-axis text,
    .mermaid svg [class*="x-axis"] text {
      font-size: 10px !important;
    }
    .error {
      border: 1px solid #ef4444;
      border-radius: 10px;
      padding: 10px 12px;
      background: #7f1d1d22;
      color: #fecaca;
    }
    @media (max-width: 1100px) {
      .layout { grid-template-columns: 1fr; }
      .toc { position: static; max-height: none; border-right: 0; }
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="title">Alibre Design on GitHub</div>
      <div id="meta" class="meta">Loading README...</div>
      <div class="spacer"></div>
      <select id="themeSelect" aria-label="Theme">
        <option value="light">light</option>
        <option value="dark">dark</option>
        <option value="solarized-light">solarized-light</option>
        <option value="solarized-dark">solarized-dark</option>
        <option value="windows11-light">windows11-light</option>
        <option value="windows11-dark">windows11-dark</option>
        <option value="github-light">github-light</option>
        <option value="github-dark">github-dark</option>
        <option value="seamless-light">seamless-light</option>
        <option value="seamless-dark">seamless-dark</option>
      </select>
      <button id="themeBtn" type="button">Light Mode</button>
    </div>
  </header>
  <main>
    <div class="layout">
      <nav id="toc" class="toc">
        <div class="toc-title">Contents</div>
        <div id="tocLinks"></div>
      </nav>
      <article id="report" class="report"></article>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
  <script>
    const root = document.documentElement;
    const reportEl = document.getElementById('report');
    const metaEl = document.getElementById('meta');
    const themeBtn = document.getElementById('themeBtn');
    const themeSelect = document.getElementById('themeSelect');
    const tocLinksEl = document.getElementById('tocLinks');
    const themeKey = 'alibre-pages-theme';
    const themeClasses = ['light','dark','solarized-light','solarized-dark','windows11-light','windows11-dark','github-light','github-dark','seamless-light','seamless-dark'];

    function isDarkTheme(theme) { return theme === 'dark' || theme.endsWith('-dark'); }
    function pairedTheme(theme) {
      if (theme === 'light') return 'dark';
      if (theme === 'dark') return 'light';
      if (theme.endsWith('-light')) {
        const c = theme.replace(/-light$/, '-dark');
        return themeClasses.includes(c) ? c : 'dark';
      }
      if (theme.endsWith('-dark')) {
        const c = theme.replace(/-dark$/, '-light');
        return themeClasses.includes(c) ? c : 'light';
      }
      return isDarkTheme(theme) ? 'light' : 'dark';
    }

    function setTheme(theme) {
      const picked = themeClasses.includes(theme) ? theme : 'seamless-light';
      themeClasses.forEach(c => root.classList.remove(c));
      root.classList.add(picked);
      root.setAttribute('data-theme', isDarkTheme(picked) ? 'dark' : 'light');
      localStorage.setItem(themeKey, picked);
      themeSelect.value = picked;
      themeBtn.textContent = isDarkTheme(picked) ? 'Light Mode' : 'Dark Mode';
      renderMermaid();
    }

    setTheme(localStorage.getItem(themeKey) || 'seamless-light');
    themeSelect.addEventListener('change', () => setTheme(themeSelect.value));
    themeBtn.addEventListener('click', () => setTheme(pairedTheme(themeSelect.value)));

    marked.setOptions({ gfm: true, breaks: false });

    async function loadMarkdown() {
      const sources = ['./README.md', './readme-data.md'];
      for (const src of sources) {
        try {
          const r = await fetch(src, { cache: 'no-store' });
          if (!r.ok) continue;
          const text = await r.text();
          return { src, text };
        } catch {}
      }
      throw new Error('Unable to load README.md or readme-data.md');
    }

    function slugify(text) {
      return text.toLowerCase().replace(/[^a-z0-9\s-]/g, '').trim().replace(/\s+/g, '-').replace(/-+/g, '-');
    }

    function buildToc() {
      const headings = reportEl.querySelectorAll('h1, h2, h3');
      const used = new Map();
      const links = [];
      headings.forEach(h => {
        const level = Number(h.tagName.slice(1));
        const text = (h.textContent || '').trim();
        if (!text) return;
        let id = h.id || slugify(text);
        const count = used.get(id) || 0;
        used.set(id, count + 1);
        if (count > 0) id = `${id}-${count + 1}`;
        h.id = id;
        links.push(`<a class="l${level}" href="#${id}">${text}</a>`);
      });
      tocLinksEl.innerHTML = links.join('') || '<span class="meta">No headings found.</span>';
    }

    function postProcess() {
      reportEl.querySelectorAll('table').forEach(t => {
        if (!t.parentElement.classList.contains('table-wrap')) {
          const w = document.createElement('div');
          w.className = 'table-wrap';
          t.parentElement.insertBefore(w, t);
          w.appendChild(t);
        }
      });
      reportEl.querySelectorAll('pre code').forEach(code => {
        const cls = code.className || '';
        const text = (code.textContent || '').trim();
        const isMermaid = cls.includes('language-mermaid') || text.startsWith('pie showData') || text.startsWith('graph ') || text.startsWith('flowchart ') || text.startsWith('sequenceDiagram') || text.startsWith('gantt') || text.startsWith('erDiagram');
        if (!isMermaid) return;
        const wrap = document.createElement('div');
        wrap.className = 'mermaid-wrap';
        const m = document.createElement('div');
        m.className = 'mermaid';
        m.setAttribute('data-graph', text);
        m.textContent = text;
        wrap.appendChild(m);
        const pre = code.closest('pre');
        pre.parentElement.replaceChild(wrap, pre);
      });
    }

    function getMermaidThemeVariables() {
      const css = getComputedStyle(root);
      const v = (name, fallback) => (css.getPropertyValue(name) || '').trim() || fallback;
      return {
        darkMode: root.getAttribute('data-theme') === 'dark',
        background: v('--color-bg', '#ffffff'),
        textColor: v('--color-neutral-12', '#0f172a'),
        titleColor: v('--color-neutral-12', '#0f172a'),
        primaryColor: v('--color-neutral-2', '#f8fafc'),
        primaryTextColor: v('--color-neutral-12', '#0f172a'),
        primaryBorderColor: v('--color-neutral-7', '#94a3b8'),
        lineColor: v('--color-neutral-9', '#64748b'),
        secondaryColor: v('--color-neutral-3', '#eef2f7'),
        tertiaryColor: v('--color-neutral-1', '#ffffff'),
        clusterBkg: v('--color-neutral-2', '#f8fafc'),
        clusterBorder: v('--color-neutral-7', '#94a3b8'),
        edgeLabelBackground: v('--color-bg', '#ffffff'),
        cScale0: v('--color-accent-4', '#bfdbfe'),
        cScale1: v('--color-accent-secondary-4', '#ddd6fe'),
        cScale2: v('--color-accent-6', '#93c5fd'),
        cScale3: v('--color-accent-secondary-6', '#c4b5fd'),
        cScale4: v('--color-accent-8', '#60a5fa'),
        cScale5: v('--color-accent-secondary-8', '#a78bfa'),
        cScale6: v('--color-accent-10', '#3b82f6'),
        cScale7: v('--color-accent-secondary-10', '#8b5cf6'),
        cScale8: v('--color-accent-11', '#2563eb'),
        cScale9: v('--color-accent-secondary-11', '#7c3aed'),
        plotColorPalette: [
          v('--color-accent-8', '#60a5fa'),
          v('--color-accent-secondary-8', '#a78bfa'),
          v('--color-accent-10', '#3b82f6'),
          v('--color-accent-secondary-10', '#8b5cf6'),
          v('--color-accent-6', '#93c5fd'),
          v('--color-accent-secondary-6', '#c4b5fd')
        ].join(',')
      };
    }

    function parseXyChartXAxisLabels(graph) {
      if (!graph || !graph.includes('xychart-beta')) return [];
      const m = graph.match(/x-axis\s*\[(.*?)\]/s);
      if (!m) return [];
      return (m[1].match(/"([^"]*)"/g) || [])
        .map(s => s.replace(/^"|"$/g, ''))
        .filter(Boolean);
    }

    function adjustXyChartLayout(blocks) {
      blocks.forEach(b => {
        const graph = b.dataset.graph || '';
        const labels = parseXyChartXAxisLabels(graph);
        if (!labels.length) return;
        const svg = b.querySelector('svg');
        if (!svg) return;
        const container = b.closest('.mermaid-wrap');
        const containerWidth = Math.max(container?.clientWidth || 0, 760);
        const spacingWidth = Math.max(containerWidth, Math.round(containerWidth * 1.6));
        const scaleDown = 0.52;
        const baseHeight = Number(svg.getAttribute('height') || '0');
        const finalWidth = Math.round(spacingWidth * scaleDown);
        svg.style.width = `${finalWidth}px`;
        svg.style.minWidth = `${finalWidth}px`;
        if (baseHeight > 0) {
          const finalHeight = Math.round(baseHeight * scaleDown);
          svg.style.height = `${finalHeight}px`;
          svg.style.maxHeight = `${finalHeight}px`;
        }

        const labelSet = new Set(labels);
        svg.querySelectorAll('text').forEach(t => {
          const txt = (t.textContent || '').trim();
          if (!labelSet.has(txt)) return;
          t.style.fontSize = '7px';
        });
      });
    }

    async function renderMermaid() {
      const blocks = reportEl.querySelectorAll('.mermaid[data-graph]');
      if (!blocks.length || !window.mermaid) return;
      mermaid.initialize({
        startOnLoad: false,
        theme: 'base',
        themeVariables: getMermaidThemeVariables()
      });
      blocks.forEach(b => {
        b.removeAttribute('data-processed');
        b.textContent = b.dataset.graph || '';
      });
      try {
        await mermaid.run({ nodes: blocks });
        adjustXyChartLayout(blocks);
      } catch {}
    }

    async function boot() {
      try {
        const loaded = await loadMarkdown();
        const rawHtml = marked.parse(loaded.text);
        const safeHtml = DOMPurify.sanitize(rawHtml, {
          USE_PROFILES: { html: true },
          FORBID_TAGS: ['script', 'iframe', 'object', 'embed'],
          FORBID_ATTR: ['onerror', 'onload', 'onclick', 'onmouseover', 'onfocus']
        });
        reportEl.innerHTML = safeHtml;
        postProcess();
        buildToc();
        await renderMermaid();
        const snap = loaded.text.split('\n').find(l => l.startsWith('Snapshot UTC:'));
        metaEl.textContent = snap || '';
      } catch (e) {
        metaEl.textContent = 'Load failed';
        reportEl.innerHTML = `<div class="error">${String(e)}</div>`;
      }
    }

    boot();
  </script>
</body>
</html>
